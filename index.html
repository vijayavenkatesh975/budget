<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Budget Analyzer</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        :root { 
            --text-primary: #1a202c; 
            --bg-primary: #f3f4f6; 
            --bg-secondary: #ffffff; 
            --border-color: #e2e8f0; 
        }
        .dark { 
            --text-primary: #e5e7eb; 
            --bg-primary: #111827; 
            --bg-secondary: #1f2937; 
            --border-color: #4b5563; 
        }
        body {
            background: linear-gradient(45deg, var(--bg-primary), #e5e7eb, #d1d5db);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            color: var(--text-primary);
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%239C92AC" fill-opacity="0.1"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
            z-index: -1;
        }
        .dark body {
            background: linear-gradient(45deg, var(--bg-primary), #1f2937, #374151);
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .bg-white { background: var(--bg-secondary); }
        .border { border-color: var(--border-color); }
        .invalid { border-color: #f87171 !important; }
        .input-field { 
            background: #f7fafc; 
            color: #1a202c; 
            border-color: #e2e8f0; 
            min-height: 48px; 
        }
        .dark .input-field { 
            background: #374151; 
            color: #e5e7eb; 
            border-color: #4b5563; 
        }
        .section-text, .section-container p { 
            color: #ffffff; 
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5); 
        }
        .section-income { background: linear-gradient(135deg, #15803d, #22c55e); }
        .section-expenses { background: linear-gradient(135deg, #c2410c, #f97316); }
        .section-notes { background: linear-gradient(135deg, #b45309, #f59e0b); }
        .section-savings { background: linear-gradient(135deg, #1e40af, #3b82f6); }
        .section-history { background: linear-gradient(135deg, #6b21a8, #a855f7); }
        .section-import { background: linear-gradient(135deg, #3730a3, #6366f1); }
        .section-actions { background: linear-gradient(135deg, #4b5563, #6b7280); }
        .section-results { background: linear-gradient(135deg, #0e7490, #06b6d4); }
        .section-monthly-pie { background: linear-gradient(135deg, #047857, #10b981); }
        .section-monthly-bar { background: linear-gradient(135deg, #b91c1c, #f87171); }
        .section-yearly-chart { background: linear-gradient(135deg, #7e22ce, #c084fc); }
        .section-yearly-compare { background: linear-gradient(135deg, #1e3a8a, #60a5fa); }
        .section-category-trends { background: linear-gradient(135deg, #4c1d95, #7c3aed); }
        .chart-container { 
            border-radius: 0.5rem; 
            padding: 1rem; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            background: rgba(255, 255, 255, 0.1); 
        }
        canvas { max-height: 300px; width: 100% !important; }
        .progress-bar { transition: width 300ms ease-in-out; }
        .slide-in { 
            opacity: 0; 
            transform: translateX(-20px); 
            animation: slideIn 0.5s ease-out forwards; 
        }
        @keyframes slideIn { 
            to { opacity: 1; transform: translateX(0); } 
        }
        .btn-analyze { background: linear-gradient(90deg, #1e40af, #3b82f6); }
        .btn-reset { background: linear-gradient(90deg, #b91c1c, #f87171); }
        .btn-export { background: linear-gradient(90deg, #15803d, #22c55e); }
        .btn-backup { background: linear-gradient(90deg, #4c1d95, #7c3aed); }
        .btn-download { background: linear-gradient(90deg, #b45309, #f59e0b); }
        .btn-analyze:hover, .btn-reset:hover, .btn-export:hover, .btn-backup:hover, .btn-download:hover { 
            filter: brightness(1.1); 
            transform: scale(1.05); 
        }
        .accordion-header { 
            cursor: pointer; 
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .accordion-content { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.3s ease, opacity 0.3s ease; 
            opacity: 0; 
            padding: 0 0.75rem; 
        }
        .accordion-content.open { 
            max-height: none; 
            opacity: 1; 
            padding: 0.75rem; 
        }
        .year-selector { 
            background: linear-gradient(90deg, #1e40af, #3b82f6); 
            color: #fff; 
            padding: 0.5rem; 
            border-radius: 0.5rem; 
        }
        @media (max-width: 640px) {
            body { padding: 0.5rem; }
            .grid-cols-2 { grid-template-columns: 1fr; }
            .max-w-4xl { max-width: 100%; padding: 1rem; }
            canvas { max-height: 250px !important; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="bg-white dark:bg-gray-800 p-4 sm:p-8 rounded-xl shadow-2xl w-full max-w-4xl slide-in section-container">
        <h1 class="text-2xl sm:text-3xl font-extrabold text-center mb-4">Smart Budget Analyzer</h1>
        <div class="flex justify-end mb-2">
            <button onclick="toggleTheme()" class="text-xl p-2 rounded-full bg-gradient-to-r from-blue-600 to-blue-400 text-white hover:shadow-lg" aria-label="Toggle theme">
                <span id="themeIcon">ðŸ’¡</span>
            </button>
        </div>
        <div class="mb-4 section-income p-3 sm:p-4 rounded-lg slide-in section-container">
            <h2 class="text-base sm:text-lg font-semibold mb-2 section-text">Monthly Income</h2>
            <p class="text-sm mb-2">Enter income</p>
            <input id="income" type="number" min="0" step="0.01" class="input-field w-full p-2" placeholder="Type income" aria-label="Income">
        </div>
        <div class="section-expenses p-3 sm:p-4 rounded-lg slide-in mb-4 section-container">
            <h2 class="text-base sm:text-lg font-semibold mb-2 section-text">Expenses</h2>
            <p class="text-sm mb-2">Add expense categories</p>
            <div class="flex justify-end mb-2">
                <select id="sortCategories" class="p-2 border rounded-lg input-field" onchange="sortCategories()" aria-label="Sort by">
                    <option value="name">Name</option>
                    <option value="amount">Amount</option>
                </select>
            </div>
            <div id="expenseCategories" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
            <div class="mt-2 flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
                <input id="newCategoryName" type="text" class="p-2 border rounded-lg flex-1 input-field" placeholder="New category" aria-label="Category Name">
                <input id="newCategoryAmount" type="number" min="0" step="0.01" class="p-2 border rounded-lg sm:w-1/3 input-field" placeholder="Amount" aria-label="Category Amount">
                <button onclick="addCategory()" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600" aria-label="Add"><i class="fas fa-plus"></i></button>
            </div>
        </div>
        <div class="mb-4 section-notes p-3 sm:p-4 rounded-lg slide-in section-container">
            <h2 class="text-base sm:text-lg font-semibold mb-2 section-text">Notes</h2>
            <p class="text-sm mb-2">Record notes</p>
            <textarea id="expenseNotes" class="p-2 w-full border rounded-lg input-field" placeholder="Add notes" aria-label="Notes"></textarea>
        </div>
        <div class="mb-4 section-savings p-3 sm:p-4 rounded-lg slide-in section-container">
            <h2 class="text-base sm:text-lg font-semibold mb-2 section-text">Savings Goals</h2>
            <p class="text-sm mb-2">Set targets</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <div>
                    <label for="savingsGoal" class="block text-xs sm:text-sm font-medium section-text">Goal (â‚¹)</label>
                    <input id="savingsGoal" type="number" min="0" step="0.01" class="mt-1 p-2 w-full border rounded-lg input-field" placeholder="Type goal" aria-label="Goal">
                </div>
                <div>
                    <label for="currentSavings" class="block text-xs sm:text-sm font-medium section-text">Current (â‚¹)</label>
                    <input id="currentSavings" type="number" min="0" step="0.01" class="mt-1 p-2 w-full border rounded-lg input-field" placeholder="Type savings" aria-label="Savings">
                </div>
            </div>
        </div>
        <div class="mb-4 section-history p-3 sm:p-4 rounded-lg slide-in section-container">
            <h2 class="text-base sm:text-lg font-semibold mb-2 section-text">Past Budgets</h2>
            <p class="text-sm mb-2">Review budgets</p>
            <div id="historyAccordion"></div>
            <div class="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0 mt-2">
                <button onclick="editHistoricalData()" class="flex-1 bg-yellow-500 text-white p-2 rounded-lg hover:bg-yellow-600" aria-label="Edit">Edit</button>
                <button onclick="saveHistoricalData()" class="flex-1 bg-green-500 text-white p-2 rounded-lg hover:bg-green-600" disabled id="saveHistoryBtn" aria-label="Save">Save</button>
            </div>
        </div>
        <div class="mb-4 section-import p-3 sm:p-4 rounded-lg slide-in section-container">
            <h2 class="text-base sm:text-lg font-semibold mb-2 section-text">Import</h2>
            <p class="text-sm mb-2">Upload CSV</p>
            <input id="importFile" type="file" accept=".csv" class="p-2 w-full border rounded-lg input-field" aria-label="Import">
            <button onclick="importData()" class="mt-2 bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600" aria-label="Import">Import</button>
        </div>
        <div class="mb-4 section-actions p-3 sm:p-4 rounded-lg slide-in section-container">
            <p class="text-sm mb-2">Manage actions</p>
            <div class="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
                <button onclick="calculateBudget()" class="btn-analyze text-white p-2 rounded-lg font-semibold" aria-label="Analyze">Analyze</button>
                <button onclick="resetSavings()" class="btn-reset text-white p-2 rounded-lg" aria-label="Reset">Reset</button>
                <button onclick="exportData()" class="btn-export text-white p-2 rounded-lg" aria-label="Export">Export</button>
                <button onclick="backupData()" class="btn-backup text-white p-2 rounded-lg" aria-label="Backup">Backup</button>
            </div>
        </div>
        <div id="result" class="section-results p-3 sm:p-4 rounded-lg slide-in section-container" role="region" aria-live="polite">
            <div class="accordion-header rounded-lg slide-in" onclick="toggleAccordion('results-content')" role="button" tabindex="0" aria-expanded="false" aria-controls="results-content">
                <h3 class="text-lg font-semibold section-text">Summary</h3>
                <i class="fas fa-chevron-down" id="results-content-chevron"></i>
            </div>
            <div id="results-content" class="accordion-content">
                <p class="text-sm mb-2">View details</p>
            </div>
        </div>
        <div class="section-monthly-pie p-3 sm:p-4 rounded-lg slide-in section-container">
            <div class="accordion-header rounded-lg slide-in" onclick="toggleAccordion('monthly-pie')" role="button" tabindex="0" aria-expanded="false" aria-controls="monthly-pie">
                <h3 class="text-lg font-semibold section-text">Expense Pie</h3>
                <i class="fas fa-chevron-down" id="monthly-pie-chevron"></i>
            </div>
            <div id="monthly-pie" class="accordion-content">
                <p class="text-sm mb-2">See distribution</p>
                <select id="monthly-pie-year" class="year-selector mb-2 w-full" onchange="updateCategoryPieChart()" aria-label="Year">
                    <option value="2025">2025</option>
                </select>
                <div class="chart-container">
                    <canvas id="categoryPieChart"></canvas>
                    <button onclick="downloadChart('categoryPieChart', 'expense_distribution.png')" class="btn-download text-white p-2 mt-2 rounded-lg" aria-label="Download">Download</button>
                </div>
            </div>
        </div>
        <div class="section-monthly-bar p-3 sm:p-4 rounded-lg slide-in section-container">
            <div class="accordion-header rounded-lg slide-in" onclick="toggleAccordion('monthly-bar')" role="button" tabindex="0" aria-expanded="false" aria-controls="monthly-bar">
                <h3 class="text-lg font-semibold section-text">Expense Bar</h3>
                <i class="fas fa-chevron-down" id="monthly-bar-chevron"></i>
            </div>
            <div id="monthly-bar" class="accordion-content">
                <p class="text-sm mb-2">Compare amounts</p>
                <select id="monthly-bar-year" class="year-selector mb-2 w-full" onchange="updateCategoryBarChart()" aria-label="Year">
                    <option value="2025">2025</option>
                </select>
                <div class="chart-container">
                    <canvas id="categoryBarChart"></canvas>
                    <button onclick="downloadChart('categoryBarChart', 'expense_breakdown.png')" class="btn-download text-white p-2 mt-2 rounded-lg" aria-label="Download">Download</button>
                </div>
            </div>
        </div>
        <div class="section-yearly-chart p-3 sm:p-4 rounded-lg slide-in section-container">
            <div class="accordion-header rounded-lg slide-in" onclick="toggleAccordion('yearly-chart')" role="button" tabindex="0" aria-expanded="false" aria-controls="yearly-chart">
                <h3 class="text-lg font-semibold section-text">Savings Trend</h3>
                <i class="fas fa-chevron-down" id="yearly-chart-chevron"></i>
            </div>
            <div id="yearly-chart" class="accordion-content">
                <p class="text-sm mb-2">Track savings</p>
                <select id="yearly-year" class="year-selector mb-2 w-full" onchange="updateYearlyChart()" aria-label="Year">
                    <option value="2025">2025</option>
                </select>
                <div class="chart-container">
                    <canvas id="yearlyChart"></canvas>
                    <button onclick="downloadChart('yearlyChart', 'yearly_savings.png')" class="btn-download text-white p-2 mt-2 rounded-lg" aria-label="Download">Download</button>
                </div>
            </div>
        </div>
        <div class="section-yearly-compare p-3 sm:p-4 rounded-lg slide-in section-container">
            <div class="accordion-header rounded-lg slide-in" onclick="toggleAccordion('yearly-compare')" role="button" tabindex="0" aria-expanded="false" aria-controls="yearly-compare">
                <h3 class="text-lg font-semibold section-text">Yearly Savings</h3>
                <i class="fas fa-chevron-down" id="yearly-compare-chevron"></i>
            </div>
            <div id="yearly-compare" class="accordion-content">
                <p class="text-sm mb-2">Compare savings</p>
                <div class="chart-container">
                    <canvas id="yearlyCompareChart"></canvas>
                    <button onclick="downloadChart('yearlyCompareChart', 'savings_across_years.png')" class="btn-download text-white p-2 mt-2 rounded-lg" aria-label="Download">Download</button>
                </div>
            </div>
        </div>
        <div class="section-category-trends p-3 sm:p-4 rounded-lg slide-in section-container">
            <div class="accordion-header rounded-lg slide-in" onclick="toggleAccordion('category-trends')" role="button" tabindex="0" aria-expanded="false" aria-controls="category-trends">
                <h3 class="text-lg font-semibold section-text">Trends</h3>
                <i class="fas fa-chevron-down" id="category-trends-chevron"></i>
            </div>
            <div id="category-trends" class="accordion-content">
                <p class="text-sm mb-2">Monitor spending</p>
                <select id="trends-year" class="year-selector mb-2 w-full" onchange="updateCategoryTrendsChart()" aria-label="Year">
                    <option value="2025">2025</option>
                </select>
                <div class="chart-container">
                    <canvas id="categoryTrendsChart"></canvas>
                    <button onclick="downloadChart('categoryTrendsChart', 'category_trends.png')" class="btn-download text-white p-2 mt-2 rounded-lg" aria-label="Download">Download</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        Chart.register(ChartDataLabels);
        let monthlySavingsHistory = JSON.parse(localStorage.getItem('monthlySavingsHistory')) || [];
        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || [
            { id: 'housing', name: 'Housing', amount: 0 },
            { id: 'groceries', name: 'Groceries', amount: 0 },
            { id: 'transport', name: 'Transport', amount: 0 },
            { id: 'utilities', name: 'Utilities', amount: 0 },
            { id: 'entertainment', name: 'Entertainment', amount: 0 },
            { id: 'other', name: 'Other', amount: 0 }
        ];
        let charts = { categoryPieChart: null, categoryBarChart: null, yearlyChart: null, yearlyCompareChart: null, categoryTrendsChart: null };
        let editingMonth = null;
        let debounceTimeout = null;
        const chartCache = new Map();
        function renderCategories() {
            const container = document.getElementById('expenseCategories');
            if (!container) return;
            container.innerHTML = customCategories.map(cat => `
                <div class="slide-in">
                    <label for="${cat.id}" class="block text-xs section-text">${cat.name}</label>
                    <input id="${cat.id}" type="number" min="0" step="0.01" class="mt-1 p-2 w-full border rounded-lg expense-input input-field" placeholder="${cat.name}" value="${cat.amount}" aria-label="${cat.name}">
                    <button onclick="removeCategory('${cat.id}')" class="text-red-500 text-xs mt-1 hover:text-red-600" aria-label="Remove ${cat.name}">Remove</button>
                </div>
            `).join('');
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            document.querySelectorAll('.expense-input').forEach(input => input.addEventListener('input', debounce(calculateBudget, 300)));
        }
        function addCategory() {
            const nameInput = document.getElementById('newCategoryName');
            const amountInput = document.getElementById('newCategoryAmount');
            if (!nameInput || !amountInput) return;
            const name = nameInput.value.trim();
            const amount = parseFloat(amountInput.value) || 0;
            if (name && amount >= 0) {
                customCategories.push({ id: 'cat' + Date.now(), name, amount });
                localStorage.setItem('customCategories', JSON.stringify(customCategories));
                nameInput.value = '';
                amountInput.value = '';
                chartCache.clear();
                renderCategories();
                updateHistoryAccordion();
                calculateBudget();
            } else {
                notifyUser('Error', 'Enter valid name and amount.');
            }
        }
        function removeCategory(id) {
            customCategories = customCategories.filter(cat => cat.id !== id);
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            chartCache.clear();
            renderCategories();
            updateHistoryAccordion();
            calculateBudget();
        }
        function sortCategories() {
            const sortBy = document.getElementById('sortCategories')?.value;
            if (!sortBy) return;
            customCategories.sort((a, b) => sortBy === 'name' ? a.name.localeCompare(b.name) : b.amount - a.amount);
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            chartCache.clear();
            renderCategories();
            calculateBudget();
        }
        function updateHistoryAccordion() {
            const accordion = document.getElementById('historyAccordion');
            if (!accordion) return;
            const years = [...new Set(monthlySavingsHistory.map(entry => entry.year))].sort((a, b) => b - a);
            accordion.innerHTML = years.map(year => `
                <div class="accordion-header bg-gray-50 dark:bg-gray-700 p-2 rounded-lg mb-2 slide-in" onclick="toggleAccordion('year-${year}')" role="button" tabindex="0" aria-expanded="false" aria-controls="year-${year}">
                    <span class="font-semibold section-text">${year}</span>
                    <i class="fas fa-chevron-down" id="year-${year}-chevron"></i>
                </div>
                <div id="year-${year}" class="accordion-content">
                    ${monthlySavingsHistory.filter(entry => entry.year === year).map((entry, index) => {
                        const date = new Date(`${entry.month} ${entry.day}, ${entry.year}`);
                        const formattedDate = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                        return `
                            <div class="p-2 pl-4 hover:bg-gray-200 dark:hover:bg-gray-600 cursor-pointer slide-in" onclick="loadHistoricalData(${monthlySavingsHistory.indexOf(entry)})" role="button" tabindex="0" aria-label="View ${formattedDate}">
                                ${formattedDate}: â‚¹${entry.savings.toFixed(2)}
                            </div>
                        `;
                    }).join('')}
                </div>
            `).join('');
        }
        function toggleAccordion(id) {
            const content = document.getElementById(id);
            if (!content) return;
            const chevron = document.getElementById(`${id}-chevron`);
            const header = content.previousElementSibling;
            const isOpen = content.classList.toggle('open');
            if (chevron) {
                chevron.classList.toggle('fa-chevron-down', !isOpen);
                chevron.classList.toggle('fa-chevron-up', isOpen);
            }
            if (header) header.setAttribute('aria-expanded', isOpen);
            if (isOpen) {
                if (id === 'monthly-pie') updateCategoryPieChart();
                if (id === 'monthly-bar') updateCategoryBarChart();
                if (id === 'yearly-chart') updateYearlyChart();
                if (id === 'yearly-compare') updateYearlyCompareChart();
                if (id === 'category-trends') updateCategoryTrendsChart();
            }
        }
        function loadHistoricalData(index) {
            editingMonth = index;
            const entry = monthlySavingsHistory[index];
            const incomeInput = document.getElementById('income');
            if (incomeInput) incomeInput.value = entry.income || '';
            customCategories.forEach(cat => {
                const amount = entry.expenses?.[cat.id] || 0;
                const input = document.getElementById(cat.id);
                if (input) {
                    input.value = amount;
                    cat.amount = amount;
                }
            });
            const notesInput = document.getElementById('expenseNotes');
            if (notesInput) notesInput.value = entry.notes || '';
            const date = new Date(`${entry.month} ${entry.day}, ${entry.year}`);
            const formattedDate = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            document.getElementById('results-content').innerHTML = `
                <p class="text-sm section-text mb-2">View details</p>
                <div class="bg-gray-50 p-3 rounded-lg slide-in dark:bg-gray-700">
                    <h3 class="text-base font-semibold section-text">${formattedDate}</h3>
                    <p><strong>Income:</strong> â‚¹${entry.income.toFixed(2)}</p>
                    <p><strong>Savings:</strong> â‚¹${entry.savings.toFixed(2)}</p>
                    <h4 class="mt-2 font-semibold section-text">Expenses:</h4>
                    ${Object.entries(entry.expenses || {}).map(([id, amount]) => {
                        const cat = customCategories.find(c => c.id === id);
                        return `<p>${cat?.name || id}: â‚¹${amount.toFixed(2)}</p>`;
                    }).join('')}
                    ${entry.notes ? `<p><strong>Notes:</strong> ${entry.notes}</p>` : ''}
                </div>
            `;
            const saveBtn = document.getElementById('saveHistoryBtn');
            if (saveBtn) saveBtn.disabled = false;
            toggleAccordion('results-content');
            calculateBudget();
        }
        function editHistoricalData() {
            if (editingMonth === null) {
                notifyUser('Error', 'Select a budget.');
                return;
            }
            const saveBtn = document.getElementById('saveHistoryBtn');
            if (saveBtn) saveBtn.disabled = false;
        }
        function saveHistoricalData() {
            if (editingMonth === null) return;
            const incomeInput = document.getElementById('income');
            const notesInput = document.getElementById('expenseNotes');
            if (!incomeInput || !notesInput) return;
            const income = parseFloat(incomeInput.value) || 0;
            const expenseNotes = notesInput.value;
            const expenses = {};
            customCategories.forEach(cat => {
                const input = document.getElementById(cat.id);
                if (input) expenses[cat.id] = parseFloat(input.value) || 0;
            });
            const totalExpenses = Object.values(expenses).reduce((sum, val) => sum + val, 0);
            const date = new Date();
            monthlySavingsHistory[editingMonth] = {
                day: date.getDate().toString(),
                month: date.toLocaleString('default', { month: 'short' }),
                year: date.getFullYear().toString(),
                savings: income - totalExpenses,
                income,
                expenses,
                notes: expenseNotes
            };
            localStorage.setItem('monthlySavingsHistory', JSON.stringify(monthlySavingsHistory));
            const saveBtn = document.getElementById('saveHistoryBtn');
            if (saveBtn) saveBtn.disabled = true;
            editingMonth = null;
            notifyUser('Success', 'Budget updated.');
            chartCache.clear();
            updateHistoryAccordion();
            calculateBudget();
        }
        function populateYearSelectors() {
            const years = [...new Set(monthlySavingsHistory.map(entry => entry.year))].sort((a, b) => b - a);
            const currentYear = new Date().getFullYear().toString();
            if (!years.includes(currentYear)) years.unshift(currentYear);
            ['monthly-pie-year', 'monthly-bar-year', 'yearly-year', 'trends-year'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = years.map(year => `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`).join('');
                }
            });
        }
        function calculateBudget() {
            const incomeInput = document.getElementById('income');
            if (!incomeInput) return;
            if (!incomeInput.value || incomeInput.value.trim() === '') {
                notifyUser('Error', 'Income required.');
                incomeInput.classList.add('invalid');
                return;
            }
            const income = parseFloat(incomeInput.value) || 0;
            const savingsGoalInput = document.getElementById('savingsGoal');
            const currentSavingsInput = document.getElementById('currentSavings');
            const notesInput = document.getElementById('expenseNotes');
            if (!savingsGoalInput || !currentSavingsInput || !notesInput) return;
            const savingsGoal = parseFloat(savingsGoalInput.value) || 0;
            const currentSavings = parseFloat(currentSavingsInput.value) || 0;
            const expenseNotes = notesInput.value;
            customCategories.forEach(cat => {
                const input = document.getElementById(cat.id);
                if (input) {
                    cat.amount = parseFloat(input.value) || 0;
                    input.classList.toggle('invalid', cat.amount < 0);
                }
            });
            [incomeInput, savingsGoalInput, currentSavingsInput].forEach(input => input.classList.toggle('invalid', parseFloat(input.value) < 0));
            if (income < 0 || customCategories.some(cat => cat.amount < 0) || savingsGoal < 0 || currentSavings < 0) {
                document.getElementById('results-content').innerHTML = `
                    <p class="text-sm section-text mb-2">View details</p>
                    <p class="text-red-400 font-semibold slide-in">Use non-negative values.</p>
                `;
                toggleAccordion('results-content');
                notifyUser('Error', 'Values must be non-negative.');
                return;
            }
            const totalExpenses = customCategories.reduce((sum, cat) => sum + cat.amount, 0);
            const monthlySavings = income - totalExpenses;
            const savingsRate = income > 0 ? (monthlySavings / income * 100).toFixed(2) : 0;
            const progressPercentage = savingsGoal > 0 ? Math.min((currentSavings / savingsGoal * 100).toFixed(1), 100) : 0;
            if (editingMonth === null) {
                const date = new Date();
                const expenses = {};
                customCategories.forEach(cat => expenses[cat.id] = cat.amount);
                monthlySavingsHistory.push({
                    day: date.getDate().toString(),
                    month: date.toLocaleString('default', { month: 'long' }),
                    year: date.getFullYear().toString(),
                    savings: monthlySavings,
                    income,
                    expenses,
                    notes: expenseNotes
                });
                localStorage.setItem('monthlySavingsHistory', JSON.stringify(monthlySavingsHistory));
            }
            chartCache.clear();
            updateHistoryAccordion();
            populateYearSelectors();
            const expenseBreakdown = `
                <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-lg slide-in">
                    <h3 class="text-sm font-semibold section-text">Expenses</h3>
                    ${customCategories.map(cat => `<p class="section-text">${cat.name}: â‚¹${cat.amount.toFixed(2)} (${totalExpenses > 0 ? ((cat.amount / totalExpenses) * 100).toFixed(1) : 0}%)</p>`).join('')}
                </div>
            `;
            const savingsProgress = `
                <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-lg slide-in">
                    <h3 class="text-sm font-semibold section-text">Savings</h3>
                    <p class="section-text">Current: â‚¹${currentSavings.toFixed(2)} / Goal: â‚¹${savingsGoal.toFixed(2)}</p>
                    <div class="w-full bg-gray-200 rounded-full h-4 mt-2 dark:bg-gray-600">
                        <div class="bg-blue-500 h-4 rounded-full progress-bar" style="width: ${progressPercentage}%"></div>
                    </div>
                    <p class="section-text">${progressPercentage}%</p>
                </div>
            `;
            let alerts = '';
            if (totalExpenses / income > 0.9 && income > 0) {
                alerts = '<p class="text-red-400 font-semibold mt-2 slide-in">Warning: Expenses over 90% of income.</p>';
                notifyUser('Warning', 'Expenses are high.');
            }
            document.getElementById('results-content').innerHTML = `
                <p class="text-sm section-text mb-2">View details</p>
                <div class="bg-blue-50 p-3 rounded-lg slide-in dark:bg-blue-900">
                    <p class="text-lg font-bold text-blue-700 dark:text-blue-300">Savings: â‚¹${monthlySavings.toFixed(2)}</p>
                    <p class="text-sm font-bold text-blue-600 dark:text-blue-400">Rate: ${savingsRate}%</p>
                </div>
                ${expenseBreakdown}
                ${savingsProgress}
                ${alerts}
            `;
            toggleAccordion('results-content');
            if (document.getElementById('monthly-pie')?.classList.contains('open')) updateCategoryPieChart();
            if (document.getElementById('monthly-bar')?.classList.contains('open')) updateCategoryBarChart();
            if (document.getElementById('yearly-chart')?.classList.contains('open')) updateYearlyChart();
            if (document.getElementById('yearly-compare')?.classList.contains('open')) updateYearlyCompareChart();
            if (document.getElementById('category-trends')?.classList.contains('open')) updateCategoryTrendsChart();
        }
        function updateCategoryPieChart() {
            const yearSelect = document.getElementById('monthly-pie-year');
            if (!yearSelect) return;
            const year = yearSelect.value;
            const cacheKey = `pie-${year}`;
            if (chartCache.has(cacheKey)) return;
            const filteredData = monthlySavingsHistory.filter(entry => entry.year === year);
            const latestEntry = filteredData[filteredData.length - 1] || { expenses: {} };
            const totalExpenses = Object.values(latestEntry.expenses || {}).reduce((sum, val) => sum + val, 0);
            const canvas = document.getElementById('categoryPieChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;
            if (totalExpenses === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ffffff';
                ctx.textAlign = 'center';
                ctx.fillText('No data', canvas.width / 2, canvas.height / 2);
                if (charts.categoryPieChart) {
                    charts.categoryPieChart.destroy();
                    charts.categoryPieChart = null;
                }
                return;
            }
            if (charts.categoryPieChart) {
                charts.categoryPieChart.destroy();
                charts.categoryPieChart = null;
            }
            charts.categoryPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: customCategories.map(cat => cat.name),
                    datasets: [{
                        data: customCategories.map(cat => latestEntry.expenses[cat.id] || 0),
                        backgroundColor: ['#ef4444', '#f97316', '#facc15', '#22c55e', '#3b82f6', '#a855f7'],
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { font: { size: 10 }, color: '#ffffff' } },
                        tooltip: { callbacks: { label: context => `${context.label}: â‚¹${context.raw.toFixed(2)} (${totalExpenses > 0 ? ((context.raw / totalExpenses) * 100).toFixed(1) : 0}%)` } },
                        datalabels: { formatter: (value, context) => totalExpenses > 0 && value > 0 ? `${((value / totalExpenses) * 100).toFixed(1)}%` : '', color: '#ffffff', font: { size: 10 } }
                    }
                }
            });
            chartCache.set(cacheKey, true);
        }
        function updateCategoryBarChart() {
            const yearSelect = document.getElementById('monthly-bar-year');
            if (!yearSelect) return;
            const year = yearSelect.value;
            const cacheKey = `bar-${year}`;
            if (chartCache.has(cacheKey)) return;
            const filteredData = monthlySavingsHistory.filter(entry => entry.year === year);
            const latestEntry = filteredData[filteredData.length - 1] || { expenses: {} };
            const totalExpenses = Object.values(latestEntry.expenses || {}).reduce((sum, val) => sum + val, 0);
            const canvas = document.getElementById('categoryBarChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;
            if (totalExpenses === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ffffff';
                ctx.textAlign = 'center';
                ctx.fillText('No data', canvas.width / 2, canvas.height / 2);
                if (charts.categoryBarChart) {
                    charts.categoryBarChart.destroy();
                    charts.categoryBarChart = null;
                }
                return;
            }
            if (charts.categoryBarChart) {
                charts.categoryBarChart.destroy();
                charts.categoryBarChart = null;
            }
            charts.categoryBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: customCategories.map(cat => cat.name),
                    datasets: [{
                        label: 'Expenses (â‚¹)',
                        data: customCategories.map(cat => latestEntry.expenses[cat.id] || 0),
                        backgroundColor: '#f87171',
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#ffffff', font: { size: 10 } } },
                        x: { ticks: { color: '#ffffff', font: { size: 10 }, maxRotation: 45, minRotation: 45 } }
                    },
                    plugins: {
                        legend: { labels: { font: { size: 10 }, color: '#ffffff' } },
                        tooltip: { callbacks: { label: context => `${context.label}: â‚¹${context.raw.toFixed(2)}` } },
                        datalabels: { formatter: value => value > 0 ? `â‚¹${value.toFixed(2)}` : '', color: '#ffffff', font: { size: 10 } }
                    }
                }
            });
            chartCache.set(cacheKey, true);
        }
        function updateYearlyChart() {
            const yearSelect = document.getElementById('yearly-year');
            if (!yearSelect) return;
            const year = yearSelect.value;
            const cacheKey = `yearly-${year}`;
            if (chartCache.has(cacheKey)) return;
            const filteredData = monthlySavingsHistory.filter(entry => entry.year === year);
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const savingsData = months.map(month => filteredData.filter(e => e.month === month).reduce((sum, e) => sum + e.savings, 0));
            const canvas = document.getElementById('yearlyChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;
            if (!savingsData.some(val => val !== 0)) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ffffff';
                ctx.textAlign = 'center';
                ctx.fillText('No data', canvas.width / 2, canvas.height / 2);
                if (charts.yearlyChart) {
                    charts.yearlyChart.destroy();
                    charts.yearlyChart = null;
                }
                return;
            }
            if (charts.yearlyChart) {
                charts.yearlyChart.destroy();
                charts.yearlyChart = null;
            }
            charts.yearlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Savings (â‚¹)',
                        data: savingsData,
                        backgroundColor: '#c084fc',
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#ffffff', font: { size: 10 } } },
                        x: { ticks: { color: '#ffffff', font: { size: 10 } } }
                    },
                    plugins: {
                        legend: { labels: { font: { size: 10 }, color: '#ffffff' } },
                        tooltip: { callbacks: { label: context => `Savings: â‚¹${context.raw.toFixed(2)}` } },
                        datalabels: { formatter: value => value !== 0 ? `â‚¹${value.toFixed(2)}` : '', color: '#ffffff', font: { size: 10 } }
                    }
                }
            });
            chartCache.set(cacheKey, true);
        }
        function updateYearlyCompareChart() {
            const cacheKey = 'yearly-compare';
            if (chartCache.has(cacheKey)) return;
            const years = [...new Set(monthlySavingsHistory.map(entry => entry.year))].sort((a, b) => a - b);
            const savingsData = years.map(year => monthlySavingsHistory.filter(entry => entry.year === year).reduce((sum, entry) => sum + entry.savings, 0));
            const canvas = document.getElementById('yearlyCompareChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;
            if (!savingsData.some(val => val !== 0)) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ffffff';
                ctx.textAlign = 'center';
                ctx.fillText('No data', canvas.width / 2, canvas.height / 2);
                if (charts.yearlyCompareChart) {
                    charts.yearlyCompareChart.destroy();
                    charts.yearlyCompareChart = null;
                }
                return;
            }
            if (charts.yearlyCompareChart) {
                charts.yearlyCompareChart.destroy();
                charts.yearlyCompareChart = null;
            }
            charts.yearlyCompareChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Savings (â‚¹)',
                        data: savingsData,
                        backgroundColor: '#60a5fa',
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#ffffff', font: { size: 10 } } },
                        x: { ticks: { color: '#ffffff', font: { size: 10 } } }
                    },
                    plugins: {
                        legend: { labels: { font: { size: 10 }, color: '#ffffff' } },
                        tooltip: { callbacks: { label: context => `Savings: â‚¹${context.raw.toFixed(2)}` } },
                        datalabels: { formatter: value => value !== 0 ? `â‚¹${value.toFixed(2)}` : '', color: '#ffffff', font: { size: 10 } }
                    }
                }
            });
            chartCache.set(cacheKey, true);
        }
        function updateCategoryTrendsChart() {
            const yearSelect = document.getElementById('trends-year');
            if (!yearSelect) return;
            const year = yearSelect.value;
            const cacheKey = `trends-${year}`;
            if (chartCache.has(cacheKey)) return;
            const filteredData = monthlySavingsHistory.filter(entry => entry.year === year);
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const datasets = customCategories.map((cat, index) => ({
                label: cat.name,
                data: months.map(month => filteredData.filter(e => e.month === month).reduce((sum, e) => sum + (e.expenses?.[cat.id] || 0), 0)),
                borderColor: ['#ef4444', '#f97316', '#facc15', '#22c55e', '#3b82f6', '#a855f7'][index % 6],
                fill: false,
                tension: 0.1
            }));
            const canvas = document.getElementById('categoryTrendsChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;
            if (!datasets.some(ds => ds.data.some(val => val !== 0))) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ffffff';
                ctx.textAlign = 'center';
                ctx.fillText('No data', canvas.width / 2, canvas.height / 2);
                if (charts.categoryTrendsChart) {
                    charts.categoryTrendsChart.destroy();
                    charts.categoryTrendsChart = null;
                }
                return;
            }
            if (charts.categoryTrendsChart) {
                charts.categoryTrendsChart.destroy();
                charts.categoryTrendsChart = null;
            }
            charts.categoryTrendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#ffffff', font: { size: 10 } } },
                        x: { ticks: { color: '#ffffff', font: { size: 10 } } }
                    },
                    plugins: {
                        legend: { labels: { font: { size: 10 }, color: '#ffffff' } },
                        tooltip: { callbacks: { label: context => `${context.dataset.label}: â‚¹${context.raw.toFixed(2)}` } },
                        datalabels: { display: false }
                    }
                }
            });
            chartCache.set(cacheKey, true);
        }
        function downloadChart(id, filename) {
            const canvas = document.getElementById(id);
            const chart = charts[id.replace('Chart', '')];
            if (!canvas || !chart) {
                notifyUser('Error', 'Chart unavailable.');
                return;
            }
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = filename;
            link.click();
            notifyUser('Success', `${filename} saved.`);
        }
        function resetSavings() {
            monthlySavingsHistory = [];
            localStorage.setItem('monthlySavingsHistory', JSON.stringify(monthlySavingsHistory));
            document.getElementById('results-content').innerHTML = `
                <p class="text-sm section-text mb-2">View details</p>
                <p class="text-blue-400 font-semibold slide-in">Data reset.</p>
            `;
            toggleAccordion('results-content');
            updateHistoryAccordion();
            populateYearSelectors();
            Object.keys(charts).forEach(key => {
                if (charts[key]) {
                    charts[key].destroy();
                    charts[key] = null;
                }
            });
            chartCache.clear();
            notifyUser('Success', 'History cleared.');
        }
        function exportData() {
            const headers = ['Day', 'Month', 'Year', 'Savings', 'Income', ...customCategories.map(cat => cat.name), 'Notes'];
            const csvContent = monthlySavingsHistory.map(entry => {
                const expenseValues = customCategories.map(cat => (entry.expenses[cat.id] || 0).toFixed(2));
                return [entry.day, entry.month, entry.year, entry.savings.toFixed(2), entry.income.toFixed(2), ...expenseValues, `"${entry.notes.replace(/"/g, '""') || ''}"`].join(',');
            }).join('\n');
            const dataStr = "data:text/csv;charset=utf-8," + encodeURIComponent(headers.join(',') + '\n' + csvContent);
            const link = document.createElement('a');
            link.href = dataStr;
            link.download = 'budget_data.csv';
            link.click();
            notifyUser('Success', 'CSV exported.');
        }
        function importData() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput || !fileInput.files[0]) {
                notifyUser('Error', 'Select CSV file.');
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const rows = text.split('\n').slice(1).filter(row => row.trim());
                    const newEntries = rows.map(row => {
                        const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(col => col.trim());
                        const [day, month, year, savings, income, ...rest] = cols;
                        if (!day || !month || !year || isNaN(parseFloat(savings)) || isNaN(parseFloat(income))) {
                            throw new Error('Invalid format');
                        }
                        const expenseValues = rest.slice(0, -1);
                        if (expenseValues.length !== customCategories.length) {
                            throw new Error('Category mismatch');
                        }
                        const expenses = {};
                        customCategories.forEach((cat, i) => {
                            expenses[cat.id] = parseFloat(expenseValues[i]) || 0;
                        });
                        const notes = rest[rest.length - 1]?.replace(/^"|"$/g, '').replace(/""/g, '"') || '';
                        return { day, month, year, savings: parseFloat(savings), income: parseFloat(income), expenses, notes };
                    });
                    monthlySavingsHistory.push(...newEntries);
                    localStorage.setItem('monthlySavingsHistory', JSON.stringify(monthlySavingsHistory));
                    document.getElementById('results-content').innerHTML = `
                        <p class="text-sm section-text mb-2">View details</p>
                        <p class="text-blue-400 font-semibold slide-in">Data imported.</p>
                    `;
                    toggleAccordion('results-content');
                    chartCache.clear();
                    updateHistoryAccordion();
                    populateYearSelectors();
                    notifyUser('Success', 'CSV imported.');
                    calculateBudget();
                } catch (e) {
                    notifyUser('Error', `Import failed: ${e.message}`);
                }
            };
            reader.readAsText(file);
        }
        function backupData() {
            const backupData = { history: monthlySavingsHistory, categories: customCategories, notes: document.getElementById('expenseNotes')?.value || '' };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
            const link = document.createElement('a');
            link.href = dataStr;
            link.download = 'budget_backup.json';
            link.click();
            notifyUser('Success', 'Backup saved.');
        }
        function notifyUser(title, message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body: message });
            } else {
                alert(`${title}: ${message}`);
            }
        }
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) themeIcon.textContent = document.documentElement.classList.contains('dark') ? 'ðŸŒ™' : 'ðŸ’¡';
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            chartCache.clear();
            Object.values(charts).filter(chart => chart).forEach(chart => chart.update());
        }
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark') {
                document.documentElement.classList.add('dark');
                const themeIcon = document.getElementById('themeIcon');
                if (themeIcon) themeIcon.textContent = 'ðŸŒ™';
            }
            renderCategories();
            updateHistoryAccordion();
            populateYearSelectors();
            const inputs = {
                income: document.getElementById('income'),
                savingsGoal: document.getElementById('savingsGoal'),
                currentSavings: document.getElementById('currentSavings')
            };
            Object.values(inputs).filter(input => input).forEach(input => input.addEventListener('input', debounce(calculateBudget, 300)));
        });
        function debounce(func, wait) {
            return function(...args) {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
    </script>
</body>
</html>