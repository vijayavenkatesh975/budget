<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Budget Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        :root {
            --text-primary: #1A2533;
            --text-secondary: #64748B;
            --bg-primary: linear-gradient(135deg, #E0F2FE, #F3E8FF);
            --bg-secondary: #F8FAFC;
            --bg-card: rgba(255, 255, 255, 0.85);
            --border-color: #CBD5E1;
            --accent-blue: #3B82F6;
            --accent-purple: #8B5CF6;
            --accent-green: #10B981;
            --accent-red: #EF4444;
            --accent-orange: #F59E0B;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            --gradient: linear-gradient(135deg, #3B82F6, #8B5CF6);
            --gradient-hover: linear-gradient(135deg, #2563EB, #7C3AED);
            --chart-bg: linear-gradient(180deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.3));
            --chart-text: #1A2533;
        }
        .dark {
            --text-primary: #F1F5F9;
            --text-secondary: #A1B2C3;
            --bg-primary: linear-gradient(135deg, #1E3A8A, #4C1D95);
            --bg-secondary: #0F172A;
            --bg-card: rgba(15, 23, 42, 0.85);
            --border-color: #334155;
            --accent-blue: #60A5FA;
            --accent-purple: #A78BFA;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --gradient: linear-gradient(135deg, #60A5FA, #A78BFA);
            --gradient-hover: linear-gradient(135deg, #3B82F6, #8B5CF6);
            --chart-bg: linear-gradient(180deg, rgba(96, 165, 250, 0.15), rgba(167, 139, 250, 0.15));
            --chart-text: #F1F5F9;
        }
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        .sidebar {
            width: 18rem;
            background: var(--bg-secondary);
            padding: 2rem 1rem;
            position: fixed;
            height: 100%;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
            border-right: 1px solid var(--border-color);
        }
        .sidebar.collapsed {
            transform: translateX(-100%);
        }
        .sidebar.active {
            transform: translateX(0);
        }
        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            color: var(--text-secondary);
            border-radius: 0.5rem;
            margin-bottom: 0.3rem;
            transition: all 0.2s ease;
            font-weight: 500;
            position: relative;
        }
        .sidebar-nav a:hover, .sidebar-nav a.active {
            background: var(--gradient);
            color: #FFFFFF;
            transform: translateX(4px);
        }
        .sidebar-nav i {
            margin-right: 0.6rem;
            font-size: 1rem;
            transition: transform 0.2s ease;
        }
        .sidebar-nav a:hover i, .sidebar-nav a.active i {
            transform: scale(1.1);
        }
        .main-content {
            margin-left: 18rem;
            padding: 2.5rem 1rem;
            width: calc(100% - 18rem);
            transition: all 0.3s ease-in-out;
        }
        .main-content.full {
            margin-left: 0;
            width: 100%;
        }
        .container {
            max-width: 80rem;
            margin: 0 auto;
        }
        .card {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            backdrop-filter: blur(12px);
            animation: zoomIn 0.5s ease-out forwards;
            opacity: 0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }
        @keyframes zoomIn {
            from { transform: scale(0.98); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .input-field, .select-field {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.8rem 1rem;
            color: var(--text-primary);
            transition: all 0.2s ease;
            width: 100%;
            font-size: 0.95rem;
            animation: fadeIn 0.3s ease-out;
        }
        .input-field:focus, .select-field:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.4);
            outline: none;
            transform: scale(1.005);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .input-group {
            position: relative;
            margin-bottom: 1.2rem;
        }
        .input-group label {
            position: absolute;
            top: -0.4rem;
            left: 0.8rem;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0 0.2rem;
            transform: translateY(-50%);
            transition: all 0.2s ease;
        }
        .input-field:not(:placeholder-shown) + label, .input-field:focus + label,
        .select-field:not(:placeholder-shown) + label, .select-field:focus + label {
            color: var(--accent-blue);
            transform: translateY(-0.9rem) scale(0.95);
        }
        .btn {
            padding: 0.8rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            background: var(--gradient);
            color: #FFFFFF;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            box-shadow: var(--shadow);
        }
        .btn:hover {
            background: var(--gradient-hover);
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }
        .btn:active {
            transform: scale(1);
        }
        .btn-ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.5), transparent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: ripple 0.5s ease-out;
        }
        @keyframes ripple {
            to { width: 300px; height: 300px; opacity: 0; }
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
            overflow-x: auto;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
            padding: 0.5rem 0;
        }
        .tab {
            padding: 0.6rem 1.2rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 0.5rem;
            font-weight: 500;
            white-space: nowrap;
            margin-right: 0.5rem;
        }
        .tab:hover {
            color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }
        .tab.active {
            background: var(--gradient);
            color: #FFFFFF;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        .tab-content.active {
            display: block;
        }
        .chart-container {
            background: var(--chart-bg);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
            border: 1px solid var(--border-color);
            color: var(--chart-text);
        }
        .chart-container:hover {
            transform: translateY(-2px);
        }
        canvas {
            max-height: 350px;
            width: 100% !important;
        }
        .theme-toggle {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            padding: 0.6rem;
            background: var(--gradient);
            color: #FFFFFF;
            border-radius: 50%;
            transition: all 0.4s ease;
            z-index: 1000;
            box-shadow: var(--shadow);
        }
        .theme-toggle:hover {
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 0.8rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow);
            opacity: 0;
            z-index: 1000;
            animation: slideInRight 3.5s ease forwards;
            font-weight: 500;
            color: #FFFFFF;
        }
        @keyframes slideInRight {
            0% { opacity: 0; transform: translateX(30px); }
            10% { opacity: 1; transform: translateX(0); }
            90% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(30px); }
        }
        .error-message {
            color: var(--accent-red);
            font-size: 0.8rem;
            margin-top: 0.3rem;
            display: none;
            animation: fadeIn 0.2s ease;
        }
        .invalid .input-field, .invalid .select-field {
            border-color: var(--accent-red);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
        }
        .invalid .error-message {
            display: block;
        }
        .progress-bar {
            transition: width 0.5s ease;
            background: var(--gradient);
        }
        .hamburger {
            display: none;
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 2000;
            padding: 0.6rem;
            background: var(--bg-secondary);
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
        }
        .hamburger:hover {
            background: var(--gradient);
            color: #FFFFFF;
            transform: scale(1.1);
        }
        .section-divider {
            border-top: 1px solid var(--border-color);
            margin: 1rem 0;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .dashboard-card {
            background: var(--bg-card);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-2px);
        }
        .dashboard-card i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--accent-blue);
        }
        @media (max-width: 640px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 1.5rem 0.75rem;
            }
            .hamburger {
                display: block;
            }
            .container {
                padding: 0.75rem;
            }
            .card {
                padding: 1.2rem;
                border-radius: 0.6rem;
            }
            .input-field, .select-field {
                font-size: 0.9rem;
                padding: 0.6rem 0.8rem;
            }
            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            .tabs {
                padding: 0.3rem 0;
            }
            .tab {
                padding: 0.5rem 0.8rem;
                font-size: 0.85rem;
            }
            .chart-container {
                padding: 1rem;
            }
            canvas {
                max-height: 200px;
            }
            .theme-toggle, .hamburger {
                top: 0.75rem;
                right: 0.75rem;
                left: 0.75rem;
                padding: 0.5rem;
            }
            h2 {
                font-size: 1.25rem;
            }
            h3 {
                font-size: 1rem;
            }
            .grid-cols-2, .grid-cols-3 {
                grid-template-columns: 1fr;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <h2 class="text-2xl font-bold mb-6 flex items-center">
            <i class="fas fa-wallet mr-2 text-accent-blue"></i> Budget
        </h2>
        <nav class="sidebar-nav">
            <a href="#dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="#expenses"><i class="fas fa-money-bill-wave"></i> Expenses</a>
            <a href="#savings-goals"><i class="fas fa-bullseye"></i> Savings Goals</a>
            <a href="#current-savings"><i class="fas fa-piggy-bank"></i> Current Savings</a>
            <a href="#analysis"><i class="fas fa-chart-line"></i> Analysis</a>
            <a href="#visualization"><i class="fas fa-chart-pie"></i> Visualization</a>
            <a href="#savings-progress"><i class="fas fa-tachometer-alt"></i> Progress</a>
            <a href="#history"><i class="fas fa-history"></i> History</a>
        </nav>
    </div>
    <button class="hamburger" onclick="toggleSidebar()" aria-label="Toggle sidebar">
        <i class="fas fa-bars text-lg"></i>
    </button>
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
        <span id="themeIcon">ðŸ’¡</span>
    </button>
    <div class="main-content" id="mainContent">
        <div class="container">
            <section id="dashboard" class="card">
                <h2 class="text-2xl font-bold mb-4">Dashboard</h2>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <i class="fas fa-wallet"></i>
                        <h3 class="text-lg font-semibold">Income</h3>
                        <p id="dashIncome" class="text-xl font-bold">â‚¹0.00</p>
                    </div>
                    <div class="dashboard-card">
                        <i class="fas fa-money-bill-wave"></i>
                        <h3 class="text-lg font-semibold">Expenses</h3>
                        <p id="dashExpenses" class="text-xl font-bold">â‚¹0.00</p>
                    </div>
                    <div class="dashboard-card">
                        <i class="fas fa-piggy-bank"></i>
                        <h3 class="text-lg font-semibold">Savings</h3>
                        <p id="dashSavings" class="text-xl font-bold">â‚¹0.00</p>
                    </div>
                    <div class="dashboard-card">
                        <i class="fas fa-bullseye"></i>
                        <h3 class="text-lg font-semibold">Goal Progress</h3>
                        <p id="dashProgress" class="text-xl font-bold">0%</p>
                    </div>
                </div>
            </section>
            <div class="section-divider"></div>
            <section id="expenses" class="card">
                <h2 class="text-2xl font-bold mb-4">Expenses</h2>
                <div class="input-group">
                    <input id="income" type="number" min="0" step="0.01" class="input-field" placeholder="Enter income (â‚¹)" aria-label="Income" aria-describedby="income-error">
                    <label for="income">Income (â‚¹)</label>
                    <p id="income-error" class="error-message">Enter valid income.</p>
                </div>
                <h3 class="text-lg font-semibold mb-3">Categories</h3>
                <div id="expenseCategories" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div class="input-group">
                        <select id="newCategoryName" class="select-field" aria-label="Category name" aria-describedby="category-name-error">
                            <option value="" disabled selected>Select or type category</option>
                            <option value="Dining">Dining</option>
                            <option value="Travel">Travel</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Education">Education</option>
                            <option value="Custom">Custom</option>
                        </select>
                        <label for="newCategoryName">Category Name</label>
                        <p id="category-name-error" class="error-message">Select or enter category.</p>
                    </div>
                    <div class="input-group">
                        <input id="newCategoryAmount" type="number" min="0" step="0.01" class="input-field" placeholder="Amount (â‚¹)" aria-label="Category amount" aria-describedby="category-amount-error">
                        <label for="newCategoryAmount">Amount (â‚¹)</label>
                        <p id="category-amount-error" class="error-message">Enter valid amount.</p>
                    </div>
                </div>
                <button onclick="addCategory()" class="btn mt-4"><i class="fas fa-plus mr-1"></i>Add Category</button>
                <div class="input-group mt-4">
                    <textarea id="expenseNotes" class="input-field" placeholder="Add notes..." aria-label="Notes" rows="3"></textarea>
                    <label for="expenseNotes">Notes</label>
                </div>
            </section>
            <div class="section-divider"></div>
            <section id="savings-goals" class="card">
                <h2 class="text-2xl font-bold mb-4">Savings Goals</h2>
                <div class="input-group">
                    <input id="savingsGoal" type="number" min="0" step="0.01" class="input-field" placeholder="Goal (â‚¹)" aria-label="Savings goal" aria-describedby="savings-goal-error">
                    <label for="savingsGoal">Savings Goal (â‚¹)</label>
                    <p id="savings-goal-error" class="error-message">Enter valid goal.</p>
                </div>
            </section>
            <div class="section-divider"></div>
            <section id="current-savings" class="card">
                <h2 class="text-2xl font-bold mb-4">Current Savings</h2>
                <div class="input-group">
                    <input id="currentSavings" type="number" min="0" step="0.01" class="input-field" placeholder="Current (â‚¹)" aria-label="Current savings" aria-describedby="current-savings-error">
                    <label for="currentSavings">Current Savings (â‚¹)</label>
                    <p id="current-savings-error" class="error-message">Enter valid amount.</p>
                </div>
                <button onclick="calculateBudget()" class="btn mt-3"><i class="fas fa-calculator mr-1"></i>Analyze Budget</button>
            </section>
            <div class="section-divider"></div>
            <section id="analysis" class="card">
                <h2 class="text-2xl font-bold mb-4">Budget Analysis</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Quick Stats</h3>
                        <div class="bg-card p-3 rounded-md shadow-sm">
                            <p id="quickStats" class="text-sm">Income: â‚¹0.00<br>Expenses: â‚¹0.00<br>Savings: â‚¹0.00</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Financial Health</h3>
                        <div class="bg-card p-3 rounded-md shadow-sm">
                            <p id="healthSummary" class="text-sm">Analyze budget for health insights.</p>
                        </div>
                    </div>
                </div>
            </section>
            <div class="section-divider"></div>
            <section id="visualization" class="card">
                <h2 class="text-2xl font-bold mb-4">Visualization</h2>
                <div class="tabs" role="tablist">
                    <div class="tab active" data-tab="pie-chart" role="tab" aria-selected="true">Pie Chart</div>
                    <div class="tab" data-tab="bar-chart" role="tab" aria-selected="false">Bar Chart</div>
                    <div class="tab" data-tab="savings-trend" role="tab" aria-selected="false">Savings Trend</div>
                    <div class="tab" data-tab="category-trends" role="tab" aria-selected="false">Category Trends</div>
                </div>
                <div id="pie-chart" class="tab-content active" role="tabpanel">
                    <select id="yearly-pie-year" class="select-field w-full mb-3" onchange="updateCategoryPieChart()" aria-label="Select year for pie chart">
                        <option value="2025">2025</option>
                    </select>
                    <div class="chart-container">
                        <canvas id="categoryPieChart"></canvas>
                        <button onclick="downloadChart('categoryPieChart', 'expense_distribution.png')" class="btn mt-3">Download Chart</button>
                    </div>
                </div>
                <div id="bar-chart" class="tab-content" role="tabpanel">
                    <select id="yearly-bar-year" class="select-field w-full mb-3" onchange="updateCategoryBarChart()" aria-label="Select year for bar chart">
                        <option value="2025">2025</option>
                    </select>
                    <div class="chart-container">
                        <canvas id="categoryBarChart"></canvas>
                        <button onclick="downloadChart('categoryBarChart', 'expense_breakdown.png')" class="btn mt-3">Download Chart</button>
                    </div>
                </div>
                <div id="savings-trend" class="tab-content" role="tabpanel">
                    <select id="yearly-year" class="select-field w-full mb-3" onchange="updateYearlyChart()" aria-label="Select year for savings trend">
                        <option value="2025">2025</option>
                    </select>
                    <div class="chart-container">
                        <canvas id="yearlyChart"></canvas>
                        <button onclick="downloadChart('yearlyChart', 'yearly_savings.png')" class="btn mt-3">Download Chart</button>
                    </div>
                </div>
                <div id="category-trends" class="tab-content" role="tabpanel">
                    <select id="trends-year" class="select-field w-full mb-3" onchange="updateCategoryTrendsChart()" aria-label="Select year for category trends">
                        <option value="2025">2025</option>
                    </select>
                    <div class="chart-container">
                        <canvas id="categoryTrendsChart"></canvas>
                        <button onclick="downloadChart('categoryTrendsChart', 'category_trends.png')" class="btn mt-3">Download Chart</button>
                    </div>
                </div>
            </section>
            <div class="section-divider"></div>
            <section id="savings-progress" class="card">
                <h2 class="text-2xl font-bold mb-4">Savings Progress</h2>
                <div>
                    <h3 class="text-lg font-semibold mb-2">Progress</h3>
                    <div class="bg-card p-3 rounded-md shadow-sm">
                        <p id="savingsSummary" class="text-sm">Enter budget details to see progress.</p>
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-3 mt-3 overflow-hidden">
                            <div id="savingsProgress" class="h-3 rounded-full progress-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </section>
            <div class="section-divider"></div>
            <section id="history" class="card">
                <h2 class="text-2xl font-bold mb-4">Past Budgets</h2>
                <div id="historyAccordion"></div>
                <div class="flex flex-wrap gap-3 mt-3">
                    <button onclick="editHistoricalData()" class="btn bg-yellow-500"><i class="fas fa-edit mr-1"></i>Edit</button>
                    <button onclick="saveHistoricalData()" class="btn bg-green-500" disabled id="saveHistoryBtn"><i class="fas fa-save mr-1"></i>Save</button>
                    <button onclick="resetSavings()" class="btn bg-red-500"><i class="fas fa-trash mr-1"></i>Reset</button>
                    <button onclick="exportData()" class="btn bg-blue-500"><i class="fas fa-download mr-1"></i>Export CSV</button>
                    <button onclick="backupData()" class="btn bg-purple-500"><i class="fas fa-cloud-upload-alt mr-1"></i>Backup</button>
                </div>
                <div class="mt-4">
                    <input id="importFile" type="file" accept=".csv,.json" class="input-field w-full" aria-label="Import CSV or JSON">
                    <button onclick="importData()" class="btn mt-3"><i class="fas fa-upload mr-1"></i>Import</button>
                </div>
            </section>
        </div>
    </div>
    <script>
        const elements = {
            income: document.getElementById('income'),
            expenseCategories: document.getElementById('expenseCategories'),
            newCategoryName: document.getElementById('newCategoryName'),
            newCategoryAmount: document.getElementById('newCategoryAmount'),
            expenseNotes: document.getElementById('expenseNotes'),
            savingsGoal: document.getElementById('savingsGoal'),
            currentSavings: document.getElementById('currentSavings'),
            savingsProgress: document.getElementById('savingsProgress'),
            savingsSummary: document.getElementById('savingsSummary'),
            quickStats: document.getElementById('quickStats'),
            healthSummary: document.getElementById('healthSummary'),
            historyAccordion: document.getElementById('historyAccordion'),
            importFile: document.getElementById('importFile'),
            saveHistoryBtn: document.getElementById('saveHistoryBtn'),
            yearlyPieYear: document.getElementById('yearly-pie-year'),
            yearlyBarYear: document.getElementById('yearly-bar-year'),
            yearlyYear: document.getElementById('yearly-year'),
            trendsYear: document.getElementById('trends-year'),
            categoryPieChart: document.getElementById('categoryPieChart'),
            categoryBarChart: document.getElementById('categoryBarChart'),
            yearlyChart: document.getElementById('yearlyChart'),
            categoryTrendsChart: document.getElementById('categoryTrendsChart'),
            dashIncome: document.getElementById('dashIncome'),
            dashExpenses: document.getElementById('dashExpenses'),
            dashSavings: document.getElementById('dashSavings'),
            dashProgress: document.getElementById('dashProgress')
        };

        let monthlySavingsHistory = JSON.parse(localStorage.getItem('monthlySavingsHistory')) || [];
        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || [
            { id: 'housing', name: 'Housing', amount: 0 },
            { id: 'groceries', name: 'Groceries', amount: 0 },
            { id: 'transport', name: 'Transport', amount: 0 },
            { id: 'utilities', name: 'Utilities', amount: 0 },
            { id: 'entertainment', name: 'Entertainment', amount: 0 },
            { id: 'other', name: 'Other', amount: 0 }
        ];
        let charts = { categoryPieChart: null, categoryBarChart: null, yearlyChart: null, categoryTrendsChart: null };
        let editingMonth = null;
        const chartCache = new Map();

        function addRippleEffect(event) {
            const button = event.currentTarget;
            if (button.classList.contains('loading')) return;
            const ripple = document.createElement('span');
            ripple.classList.add('btn-ripple');
            button.appendChild(ripple);
            setTimeout(() => ripple.remove(), 500);
        }

        function showLoading(button) {
            button.classList.add('loading');
            button.disabled = true;
            button.innerHTML += '<i class="fas fa-spinner fa-spin ml-1"></i>';
        }

        function hideLoading(button, originalText) {
            button.classList.remove('loading');
            button.disabled = false;
            button.innerHTML = originalText;
        }

        function setupScrollSpy() {
            const sections = document.querySelectorAll('section[id]');
            const navLinks = document.querySelectorAll('.sidebar-nav a');
            const observerOptions = {
                root: null,
                rootMargin: '-100px 0px -50% 0px',
                threshold: 0.1
            };
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        navLinks.forEach(link => {
                            link.classList.toggle('active', link.getAttribute('href') === `#${entry.target.id}`);
                        });
                    }
                });
            }, observerOptions);
            sections.forEach(section => observer.observe(section));
        }

        function renderCategories() {
            if (!elements.expenseCategories) return;
            elements.expenseCategories.innerHTML = customCategories.map(cat => `
                <div class="input-group">
                    <input id="${cat.id}" type="number" min="0" step="0.01" class="input-field" placeholder="Enter amount (â‚¹)" value="${cat.amount}" aria-label="${cat.name}" aria-describedby="${cat.id}-error">
                    <label for="${cat.id}">${cat.name}</label>
                    <p id="${cat.id}-error" class="error-message">Enter valid amount.</p>
                    <button onclick="removeCategory('${cat.id}')" class="btn bg-red-500 text-xs mt-2"><i class="fas fa-trash mr-1"></i>Remove</button>
                </div>
            `).join('');
        }

        function addCategory() {
            let name = elements.newCategoryName?.value.trim();
            if (name === 'Custom') {
                name = prompt('Enter custom category name:');
                if (!name || !name.trim()) {
                    showToast('error', 'Invalid category name.');
                    return;
                }
            }
            const amount = parseFloat(elements.newCategoryAmount?.value) || 0;
            const nameError = document.getElementById('category-name-error');
            const amountError = document.getElementById('category-amount-error');
            if (!name || amount < 0) {
                elements.newCategoryName?.parentElement.classList.toggle('invalid', !name);
                elements.newCategoryAmount?.parentElement.classList.toggle('invalid', amount < 0);
                if (nameError) nameError.style.display = !name ? 'block' : 'none';
                if (amountError) amountError.style.display = amount < 0 ? 'block' : 'none';
                showToast('error', 'Invalid category name or amount.');
                return;
            }
            customCategories.push({ id: 'cat' + Date.now(), name, amount });
            elements.newCategoryName.value = '';
            elements.newCategoryAmount.value = '';
            chartCache.clear();
            renderCategories();
            updateHistoryAccordion();
            showToast('success', 'Category added.');
        }

        function removeCategory(id) {
            customCategories = customCategories.filter(cat => cat.id !== id);
            chartCache.clear();
            renderCategories();
            updateHistoryAccordion();
            showToast('success', 'Category removed.');
        }

        function updateHistoryAccordion() {
            if (!elements.historyAccordion) return;
            const years = [...new Set(monthlySavingsHistory.map(entry => entry.year))].sort((a, b) => b - a);
            elements.historyAccordion.innerHTML = years.map(year => `
                <div class="bg-card p-3 rounded-md mb-2 cursor-pointer" onclick="toggleHistory('year-${year}')" role="button" aria-expanded="false">
                    <span class="font-semibold">${year}</span>
                    <i class="fas fa-chevron-down float-right" id="year-${year}-chevron"></i>
                </div>
                <div id="year-${year}" class="hidden pl-3">
                    ${monthlySavingsHistory.filter(entry => entry.year === year).map((entry, index) => {
                        const date = new Date(`${entry.month} ${entry.day}, ${entry.year}`);
                        return `
                            <div class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md" onclick="loadHistoricalData(${index})" aria-label="View ${date.toLocaleDateString()}">
                                ${date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}: â‚¹${entry.savings.toFixed(2)}
                            </div>
                        `;
                    }).join('')}
                </div>
            `).join('');
        }

        function toggleHistory(id) {
            const content = document.getElementById(id);
            if (!content) return;
            const chevron = document.getElementById(`${id}-chevron`);
            const isHidden = content.classList.contains('hidden');
            content.classList.toggle('hidden', !isHidden);
            if (chevron) {
                chevron.classList.toggle('fa-chevron-down', !isHidden);
                chevron.classList.toggle('fa-chevron-up', isHidden);
            }
        }

        function loadHistoricalData(index) {
            editingMonth = index;
            const entry = monthlySavingsHistory[index];
            if (elements.income) elements.income.value = entry.income || '';
            customCategories.forEach(cat => {
                const input = document.getElementById(cat.id);
                if (input) input.value = entry.expenses?.[cat.id] || 0;
            });
            if (elements.expenseNotes) elements.expenseNotes.value = entry.notes || '';
            if (elements.savingsGoal) elements.savingsGoal.value = entry.savingsGoal || '';
            if (elements.currentSavings) elements.currentSavings.value = entry.currentSavings || '';
            if (elements.saveHistoryBtn) elements.saveHistoryBtn.disabled = false;
            showToast('info', 'Budget loaded.');
        }

        function editHistoricalData() {
            if (editingMonth === null) {
                showToast('error', 'Select budget to edit.');
                return;
            }
            if (elements.saveHistoryBtn) elements.saveHistoryBtn.disabled = false;
        }

        function saveHistoricalData() {
            if (editingMonth === null) return;
            const income = parseFloat(elements.income?.value) || 0;
            if (isNaN(income) || income < 0) {
                showToast('error', 'Invalid income.');
                return;
            }
            const expenseNotes = elements.expenseNotes?.value || '';
            const savingsGoal = parseFloat(elements.savingsGoal?.value) || 0;
            const currentSavings = parseFloat(elements.currentSavings?.value) || 0;
            const expenses = {};
            customCategories.forEach(cat => {
                const input = document.getElementById(cat.id);
                if (input) expenses[cat.id] = parseFloat(input.value) || 0;
            });
            const totalExpenses = Object.values(expenses).reduce((sum, val) => sum + val, 0);
            const date = new Date();
            monthlySavingsHistory[editingMonth] = {
                day: date.getDate().toString(),
                month: date.toLocaleString('default', { month: 'short' }),
                year: date.getFullYear().toString(),
                savings: income - totalExpenses,
                income,
                expenses,
                notes: expenseNotes,
                savingsGoal,
                currentSavings
            };
            localStorage.setItem('monthlySavingsHistory', JSON.stringify(monthlySavingsHistory));
            if (elements.saveHistoryBtn) elements.saveHistoryBtn.disabled = true;
            editingMonth = null;
            chartCache.clear();
            updateHistoryAccordion();
            showToast('success', 'Budget updated.');
        }

        function populateYearSelectors() {
            const years = [...new Set(monthlySavingsHistory.map(entry => entry.year))].sort((a, b) => b - a);
            const currentYear = new Date().getFullYear().toString();
            if (!years.includes(currentYear)) years.unshift(currentYear);
            [elements.yearlyPieYear, elements.yearlyBarYear, elements.yearlyYear, elements.trendsYear].filter(el => el).forEach(el => {
                el.innerHTML = years.map(year => `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`).join('');
            });
        }

        function calculateBudget() {
            const button = document.querySelector('button[onclick="calculateBudget()"]');
            const originalText = button.innerHTML;
            showLoading(button);
            setTimeout(() => {
                const income = parseFloat(elements.income?.value) || 0;
                const incomeError = document.getElementById('income-error');
                if (isNaN(income) || income < 0) {
                    elements.income?.parentElement.classList.add('invalid');
                    if (incomeError) incomeError.style.display = 'block';
                    showToast('error', 'Invalid income.');
                    hideLoading(button, originalText);
                    return;
                }
                elements.income?.parentElement.classList.remove('invalid');
                if (incomeError) incomeError.style.display = 'none';

                const savingsGoal = parseFloat(elements.savingsGoal?.value) || 0;
                const currentSavings = parseFloat(elements.currentSavings?.value) || 0;
                const expenseNotes = elements.expenseNotes?.value || '';
                const savingsGoalError = document.getElementById('savings-goal-error');
                const currentSavingsError = document.getElementById('current-savings-error');
                elements.savingsGoal?.parentElement.classList.toggle('invalid', savingsGoal < 0);
                elements.currentSavings?.parentElement.classList.toggle('invalid', currentSavings < 0);
                if (savingsGoalError) savingsGoalError.style.display = savingsGoal < 0 ? 'block' : 'none';
                if (currentSavingsError) currentSavingsError.style.display = currentSavings < 0 ? 'block' : 'none';

                customCategories.forEach(cat => {
                    const input = document.getElementById(cat.id);
                    const error = document.getElementById(`${cat.id}-error`);
                    if (input && error) {
                        cat.amount = parseFloat(input.value) || 0;
                        input.parentElement.classList.toggle('invalid', cat.amount < 0);
                        error.style.display = cat.amount < 0 ? 'block' : 'none';
                    }
                });

                if (savingsGoal < 0 || currentSavings < 0 || customCategories.some(cat => cat.amount < 0)) {
                    showToast('error', 'Values must be non-negative.');
                    hideLoading(button, originalText);
                    return;
                }

                const totalExpenses = customCategories.reduce((sum, cat) => sum + cat.amount, 0);
                const monthlySavings = income - totalExpenses;
                const savingsRate = income > 0 ? (monthlySavings / income * 100).toFixed(2) : 0;
                const progressPercentage = savingsGoal > 0 ? Math.min((currentSavings / savingsGoal * 100).toFixed(1), 100) : 0;
                const expenseRatio = income > 0 ? (totalExpenses / income * 100).toFixed(1) : 0;

                if (editingMonth === null) {
                    const date = new Date();
                    const expenses = {};
                    customCategories.forEach(cat => expenses[cat.id] = cat.amount);
                    monthlySavingsHistory.push({
                        day: date.getDate().toString(),
                        month: date.toLocaleString('default', { month: 'long' }),
                        year: date.getFullYear().toString(),
                        savings: monthlySavings,
                        income,
                        expenses,
                        notes: expenseNotes,
                        savingsGoal,
                        currentSavings
                    });
                }

                localStorage.setItem('monthlySavingsHistory', JSON.stringify(monthlySavingsHistory));
                localStorage.setItem('customCategories', JSON.stringify(customCategories));
                chartCache.clear();
                updateHistoryAccordion();
                populateYearSelectors();

                elements.savingsSummary.innerHTML = `Savings: â‚¹${monthlySavings.toFixed(2)}<br>Rate: ${savingsRate}%${expenseRatio > 90 && income > 0 ? '<br><span class="text-accent-red">âš  High expenses!</span>' : ''}`;
                elements.quickStats.innerHTML = `Income: â‚¹${income.toFixed(2)}<br>Expenses: â‚¹${totalExpenses.toFixed(2)}<br>Savings: â‚¹${monthlySavings.toFixed(2)}`;
                elements.healthSummary.innerHTML = `Expense Ratio: ${expenseRatio}%<br>${expenseRatio > 90 ? '<span class="text-accent-red">High spending!</span>' : expenseRatio > 70 ? '<span class="text-accent-orange">Moderate spending</span>' : '<span class="text-accent-green">Healthy spending</span>'}`;
                elements.savingsProgress.style.width = `${progressPercentage}%`;

                // Update dashboard
                elements.dashIncome.textContent = `â‚¹${income.toFixed(2)}`;
                elements.dashExpenses.textContent = `â‚¹${totalExpenses.toFixed(2)}`;
                elements.dashSavings.textContent = `â‚¹${monthlySavings.toFixed(2)}`;
                elements.dashProgress.textContent = `${progressPercentage}%`;

                showToast('success', 'Budget analyzed.');
                hideLoading(button, originalText);
                updateCategoryPieChart();
                updateCategoryBarChart();
                updateYearlyChart();
                updateCategoryTrendsChart();
            }, 200);
        }

        function ensureChartReady(callback) {
            if (typeof Chart === 'undefined' || typeof ChartDataLabels === 'undefined') {
                setTimeout(() => ensureChartReady(callback), 100);
                return;
            }
            Chart.register(ChartDataLabels);
            callback();
        }

        function updateCategoryPieChart() {
            ensureChartReady(() => {
                const year = elements.yearlyPieYear?.value || new Date().getFullYear().toString();
                const cacheKey = `pie-${year}`;
                if (chartCache.has(cacheKey)) return;
                const filteredData = monthlySavingsHistory.filter(entry => entry.year === year);
                const latestEntry = filteredData[filteredData.length - 1] || { expenses: {} };
                const totalExpenses = Object.values(latestEntry.expenses || {}).reduce((sum, val) => sum + val, 0);
                const ctx = elements.categoryPieChart?.getContext('2d');
                const isDark = document.documentElement.classList.contains('dark');
                if (!ctx || totalExpenses === 0) {
                    if (ctx) {
                        ctx.clearRect(0, 0, elements.categoryPieChart.width, elements.categoryPieChart.height);
                        ctx.fillStyle = isDark ? '#A1B2C3' : '#64748B';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = '14px Inter';
                        ctx.fillText('No data available', elements.categoryPieChart.width / 2, elements.categoryPieChart.height / 2);
                    }
                    if (charts.categoryPieChart) charts.categoryPieChart.destroy();
                    return;
                }
                if (charts.categoryPieChart) charts.categoryPieChart.destroy();
                charts.categoryPieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: customCategories.map(cat => cat.name),
                        datasets: [{
                            data: customCategories.map(cat => latestEntry.expenses[cat.id] || 0),
                            backgroundColor: isDark ? 
                                ['#60A5FA', '#A78BFA', '#34D399', '#F87171', '#FBBF24', '#8B5CF6'] :
                                ['#1D4ED8', '#6D28D9', '#047857', '#B91C1C', '#B45309', '#4B0082'],
                            borderColor: isDark ? '#334155' : '#F8FAFC',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 1000, easing: 'easeOutQuart' },
                        plugins: {
                            legend: { position: 'bottom', labels: { color: isDark ? '#F1F5F9' : '#1A2533', font: { size: 12 } } },
                            title: { display: true, text: `Expense Distribution (${year})`, color: isDark ? '#F1F5F9' : '#1A2533', font: { size: 16, weight: '600' } },
                            tooltip: {
                                backgroundColor: isDark ? 'rgba(15, 23, 42, 0.85)' : 'rgba(255, 255, 255, 0.85)',
                                titleColor: isDark ? '#F1F5F9' : '#1A2533',
                                bodyColor: isDark ? '#F1F5F9' : '#1A2533',
                                callbacks: {
                                    label: ctx => `${ctx.label}: â‚¹${ctx.raw.toFixed(2)} (${totalExpenses > 0 ? ((ctx.raw / totalExpenses) * 100).toFixed(1) : 0}%)`
                                }
                            },
                            datalabels: {
                                formatter: (val, ctx) => totalExpenses > 0 && val > 0 ? `${((val / totalExpenses) * 100).toFixed(1)}%` : '',
                                color: '#FFFFFF',
                                font: { size: 10, weight: '600' }
                            }
                        }
                    }
                });
                chartCache.set(cacheKey, true);
            });
        }

        function updateCategoryBarChart() {
            ensureChartReady(() => {
                const year = elements.yearlyBarYear?.value || new Date().getFullYear().toString();
                const cacheKey = `bar-${year}`;
                if (chartCache.has(cacheKey)) return;
                const filteredData = monthlySavingsHistory.filter(entry => entry.year === year);
                const latestEntry = filteredData[filteredData.length - 1] || { expenses: {} };
                const totalExpenses = Object.values(latestEntry.expenses || {}).reduce((sum, val) => sum + val, 0);
                const ctx = elements.categoryBarChart?.getContext('2d');
                const isDark = document.documentElement.classList.contains('dark');
                if (!ctx || totalExpenses === 0) {
                    if (ctx) {
                        ctx.clearRect(0, 0, elements.categoryBarChart.width, elements.categoryBarChart.height);
                        ctx.fillStyle = isDark ? '#A1B2C3' : '#64748B';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = '14px Inter';
                        ctx.fillText('No data available', elements.categoryBarChart.width / 2, elements.categoryBarChart.height / 2);
                    }
                    if (charts.categoryBarChart) charts.categoryBarChart.destroy();
                    return;
                }
                if (charts.categoryBarChart) charts.categoryBarChart.destroy();
                charts.categoryBarChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: customCategories.map(cat => cat.name),
                        datasets: [{
                            label: 'Expenses (â‚¹)',
                            data: customCategories.map(cat => latestEntry.expenses[cat.id] || 0),
                            backgroundColor: isDark ? 'rgba(139, 92, 246, 0.5)' : 'rgba(59, 130, 246, 0.7)',
                            borderColor: isDark ? '#334155' : '#F8FAFC',
                            borderWidth: 2,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 1000, easing: 'easeOutQuart' },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: isDark ? '#F1F5F9' : '#1A2533', font: { size: 12 } } },
                            x: { ticks: { color: isDark ? '#F1F5F9' : '#1A2533', font: { size: 12 } } }
                        },
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: `Expense Breakdown (${year})`, color: isDark ? '#F1F5F9' : '#1A2533', font: { size: 16, weight: '600' } },
                            tooltip: {
                                backgroundColor: isDark ? 'rgba(15, 23, 42, 0.85)' : 'rgba(255, 255, 255, 0.85)',
                                titleColor: isDark ? '#F1F5F9' : '#1A2533',
                                bodyColor: isDark ? '#F1F5F9' : '#1A2533',
                                callbacks: { label: ctx => `${ctx.label}: â‚¹${ctx.raw.toFixed(2)}` }
                            },
                            datalabels: {
                                formatter: val => val > 0 ? `â‚¹${val.toFixed(0)}` : '',
                                color: isDark ? '#F1F5F9' : '#1A2533',
                                font: { size: 10, weight: '600' },
                                anchor: 'end',
                                align: 'top'
                            }
                        }
                    }
                });
                chartCache.set(cacheKey, true);
            });
        }

        function updateYearlyChart() {
            ensureChartReady(() => {
                const year = elements.yearlyYear?.value || new Date().getFullYear().toString();
                const cacheKey = `yearly-${year}`;
                if (chartCache.has(cacheKey)) return;
                const filteredData = monthlySavingsHistory.filter(entry => entry.year === year);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const savingsData = months.map(month => filteredData.filter(e => e.month.startsWith(month)).reduce((sum, e) => sum + e.savings, 0));
                const ctx = elements.yearlyChart?.getContext('2d');
                const isDark = document.documentElement.classList.contains('dark');
                if (!ctx || !savingsData.some(val => val !== 0)) {
                    if (ctx) {
                        ctx.clearRect(0, 0, elements.yearlyChart.width, elements.yearlyChart.height);
                        ctx.fillStyle = isDark ? '#A1B2C3' : '#64748B';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = '14px Inter';
                        ctx.fillText('No savings data', elements.yearlyChart.width / 2, elements.yearlyChart.height / 2);
                    }
                    if (charts.yearlyChart) charts.yearlyChart.destroy();
                    return;
                }
                if (charts.yearlyChart) charts.yearlyChart.destroy();
                charts.yearlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Savings (â‚¹)',
                            data: savingsData,
                            backgroundColor: isDark ? 'rgba(139, 92, 246, 0.5)' : 'rgba(59, 130, 246, 0.7)',
                            borderColor: isDark ? '#334155' : '#F8FAFC',
                            borderWidth: 2,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 1000, easing: 'easeOutQuart' },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: isDark ? '#F1F5F9' : '#1A2533', font: { size: 12 } } },
                            x: { ticks: { color: isDark ? '#F1F5F9' : '#1A2533', font: { size: 12 } } }
                        },
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: `Yearly Savings (${year})`, color: isDark ? '#F1F5F9' : '#1A2533', font: { size: 16, weight: '600' } },
                            tooltip: {
                                backgroundColor: isDark ? 'rgba(15, 23, 42, 0.85)' : 'rgba(255, 255, 255, 0.85)',
                                titleColor: isDark ? '#F1F5F9' : '#1A2533',
                                bodyColor: isDark ? '#F1F5F9' : '#1A2533',
                                callbacks: { label: ctx => `Savings: â‚¹${ctx.raw.toFixed(2)}` }
                            },
                            datalabels: {
                                formatter: val => val !== 0 ? `â‚¹${val.toFixed(0)}` : '',
                                color: isDark ? '#F1F5F9' : '#1A2533',
                                font: { size: 10, weight: '600' },
                                anchor: 'end',
                                align: 'top'
                            }
                        }
                    }
                });
                chartCache.set(cacheKey, true);
            });
        }

        function updateCategoryTrendsChart() {
            ensureChartReady(() => {
                const year = elements.trendsYear?.value || new Date().getFullYear().toString();
                const cacheKey = `trends-${year}`;
                if (chartCache.has(cacheKey)) return;
                const filteredData = monthlySavingsHistory.filter(entry => entry.year === year);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const isDark = document.documentElement.classList.contains('dark');
                const datasets = customCategories.map((cat, index) => ({
                    label: cat.name,
                    data: months.map(month => filteredData.filter(e => e.month.startsWith(month)).reduce((sum, e) => sum + (e.expenses?.[cat.id] || 0), 0)),
                    borderColor: isDark ? 
                        ['#60A5FA', '#A78BFA', '#34D399', '#F87171', '#FBBF24', '#8B5CF6'][index % 6] :
                        ['#1D4ED8', '#6D28D9', '#047857', '#B91C1C', '#B45309', '#4B0082'][index % 6],
                    backgroundColor: isDark ? 
                        ['#60A5FA', '#A78BFA', '#34D399', '#F87171', '#FBBF24', '#8B5CF6'][index % 6] + '33' :
                        ['#1D4ED8', '#6D28D9', '#047857', '#B91C1C', '#B45309', '#4B0082'][index % 6] + '4D',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 8
                }));
                const ctx = elements.categoryTrendsChart?.getContext('2d');
                if (!ctx || !datasets.some(d => d.data.some(val => val !== 0))) {
                    if (ctx) {
                        ctx.clearRect(0, 0, elements.categoryTrendsChart.width, elements.categoryTrendsChart.height);
                        ctx.fillStyle = isDark ? '#A1B2C3' : '#64748B';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = '14px Inter';
                        ctx.fillText('No trends data', elements.categoryTrendsChart.width / 2, elements.categoryTrendsChart.height / 2);
                    }
                    if (charts.categoryTrendsChart) charts.categoryTrendsChart.destroy();
                    return;
                }
                if (charts.categoryTrendsChart) charts.categoryTrendsChart.destroy();
                charts.categoryTrendsChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: months, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 1000, easing: 'easeOutQuart' },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: isDark ? '#F1F5F9' : '#1A2533', font: { size: 12 } } },
                            x: { ticks: { color: isDark ? '#F1F5F9' : '#1A2533', font: { size: 12 } } }
                        },
                        plugins: {
                            legend: { position: 'bottom', labels: { color: isDark ? '#F1F5F9' : '#1A2533', font: { size: 12 } } },
                            title: { display: true, text: `Category Trends (${year})`, color: isDark ? '#F1F5F9' : '#1A2533', font: { size: 16, weight: '600' } },
                            tooltip: {
                                backgroundColor: isDark ? 'rgba(15, 23, 42, 0.85)' : 'rgba(255, 255, 255, 0.85)',
                                titleColor: isDark ? '#F1F5F9' : '#1A2533',
                                bodyColor: isDark ? '#F1F5F9' : '#1A2533',
                                callbacks: { label: ctx => `${ctx.dataset.label}: â‚¹${ctx.raw.toFixed(2)}` }
                            },
                            datalabels: { display: false }
                        }
                    }
                });
                chartCache.set(cacheKey, true);
            });
        }

        function downloadChart(id, filename) {
            const canvas = document.getElementById(id);
            const button = document.querySelector(`button[onclick="downloadChart('${id}', '${filename}')"]`);
            if (!canvas || !button) {
                showToast('error', 'Chart unavailable.');
                return;
            }
            const originalText = button.innerHTML;
            showLoading(button);
            setTimeout(() => {
                try {
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = filename;
                    link.click();
                    hideLoading(button, originalText);
                    showToast('success', 'Chart downloaded.');
                } catch (e) {
                    hideLoading(button, originalText);
                    showToast('error', 'Download failed.');
                }
            }, 200);
        }

        function resetSavings() {
            const button = document.querySelector('button.btn.bg-red-500');
            const originalText = button.innerHTML;
            showLoading(button);
            setTimeout(() => {
                monthlySavingsHistory = [];
                localStorage.removeItem('monthlySavingsHistory');
                elements.savingsSummary.innerHTML = 'Data cleared.';
                elements.quickStats.innerHTML = 'Income: â‚¹0.00<br>Expenses: â‚¹0.00<br>Savings: â‚¹0.00';
                elements.healthSummary.innerHTML = 'Analyze budget.';
                elements.savingsProgress.style.width = '0%';
                elements.dashIncome.textContent = 'â‚¹0.00';
                elements.dashExpenses.textContent = 'â‚¹0.00';
                elements.dashSavings.textContent = 'â‚¹0.00';
                elements.dashProgress.textContent = '0%';
                updateHistoryAccordion();
                populateYearSelectors();
                Object.keys(charts).forEach(key => {
                    if (charts[key]) charts[key].destroy();
                });
                chartCache.clear();
                hideLoading(button, originalText);
                showToast('success', 'Data cleared.');
            }, 200);
        }

        function exportData() {
            const button = document.querySelector('button.btn.bg-blue-500');
            const originalText = button.innerHTML;
            showLoading(button);
            setTimeout(() => {
                try {
                    const headers = ['Day', 'Month', 'Year', 'Savings', 'Income', ...customCategories.map(cat => cat.name), 'Notes', 'SavingsGoal', 'CurrentSavings'];
                    const csvContent = monthlySavingsHistory.map(entry => [
                        entry.day,
                        entry.month,
                        entry.year,
                        entry.savings.toFixed(2),
                        entry.income.toFixed(2),
                        ...customCategories.map(cat => (entry.expenses[cat.id] || 0).toFixed(2)),
                        `"${entry.notes?.replace(/"/g, '""') || ''}"`,
                        entry.savingsGoal.toFixed(2),
                        entry.currentSavings.toFixed(2)
                    ].join(',')).join('\n');
                    const link = document.createElement('a');
                    link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(headers.join(',') + '\n' + csvContent);
                    link.download = 'budget_data.csv';
                    link.click();
                    hideLoading(button, originalText);
                    showToast('success', 'CSV exported.');
                } catch (e) {
                    hideLoading(button, originalText);
                    showToast('error', 'Export failed.');
                }
            }, 200);
        }

        function importData() {
            if (!elements.importFile?.files[0]) {
                showToast('error', 'Select CSV or JSON file.');
                return;
            }
            const button = document.querySelector('button[onclick="importData()"]');
            const originalText = button.innerHTML;
            showLoading(button);
            const file = elements.importFile.files[0];
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    if (file.name.endsWith('.csv')) {
                        const rows = reader.result.split('\n').slice(1).filter(row => row.trim());
                        if (rows.length === 0) throw new Error('Empty CSV');
                        const newEntries = rows.map(row => {
                            const cols = row.split(',').map(col => col.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                            if (cols.length < 6) throw new Error('Invalid CSV format');
                            const [day, month, year, savings, income, ...rest] = cols;
                            if (!day || !month || !year || isNaN(parseFloat(savings)) || isNaN(parseFloat(income))) {
                                throw new Error('Invalid CSV data');
                            }
                            const expenseValues = rest.slice(0, customCategories.length);
                            if (expenseValues.length !== customCategories.length) throw new Error('Category mismatch');
                            const expenses = {};
                            customCategories.forEach((cat, i) => expenses[cat.id] = parseFloat(expenseValues[i]) || 0);
                            const notes = rest[customCategories.length] || '';
                            const savingsGoal = parseFloat(rest[rest.length - 2]) || 0;
                            const currentSavings = parseFloat(rest[rest.length - 1]) || 0;
                            return { day, month, year, savings: parseFloat(savings), income: parseFloat(income), expenses, notes, savingsGoal, currentSavings };
                        });
                        monthlySavingsHistory.push(...newEntries);
                    } else if (file.name.endsWith('.json')) {
                        const data = JSON.parse(reader.result);
                        monthlySavingsHistory = data.history || [];
                        customCategories = data.categories || customCategories;
                        if (data.notes && elements.expenseNotes) elements.expenseNotes.value = data.notes;
                    } else {
                        throw new Error('Unsupported file type');
                    }
                    localStorage.setItem('monthlySavingsHistory', JSON.stringify(monthlySavingsHistory));
                    localStorage.setItem('customCategories', JSON.stringify(customCategories));
                    renderCategories();
                    updateHistoryAccordion();
                    populateYearSelectors();
                    chartCache.clear();
                    hideLoading(button, originalText);
                    showToast('success', 'Data imported.');
                } catch (e) {
                    hideLoading(button, originalText);
                    showToast('error', `Import failed: ${e.message}`);
                }
            };
            reader.readAsText(file);
        }

        function backupData() {
            const button = document.querySelector('button.btn.bg-purple-500');
            const originalText = button.innerHTML;
            showLoading(button);
            setTimeout(() => {
                try {
                    const backup = { history: monthlySavingsHistory, categories: customCategories, notes: elements.expenseNotes?.value || '' };
                    const link = document.createElement('a');
                    link.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(backup));
                    link.download = 'budget_backup.json';
                    link.click();
                    hideLoading(button, originalText);
                    showToast('success', 'Backup saved.');
                } catch (e) {
                    hideLoading(button, originalText);
                    showToast('error', 'Backup failed.');
                }
            }, 200);
        }

        function showToast(type, message) {
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'bg-accent-red' : type === 'info' ? 'bg-accent-blue' : 'bg-accent-green'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) themeIcon.textContent = document.documentElement.classList.contains('dark') ? 'ðŸŒ™' : 'ðŸ’¡';
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            chartCache.clear();
            Object.values(charts).filter(chart => chart).forEach(chart => chart.update());
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('full');
        }

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.setAttribute('aria-selected', 'false');
                    });
                    contents.forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    tab.setAttribute('aria-selected', 'true');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                    if (tab.dataset.tab === 'pie-chart') updateCategoryPieChart();
                    if (tab.dataset.tab === 'bar-chart') updateCategoryBarChart();
                    if (tab.dataset.tab === 'savings-trend') updateYearlyChart();
                    if (tab.dataset.tab === 'category-trends') updateCategoryTrendsChart();
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('themeIcon').textContent = 'ðŸŒ™';
            }
            renderCategories();
            updateHistoryAccordion();
            populateYearSelectors();
            setupTabs();
            setupScrollSpy();
            document.addEventListener('click', e => {
                if (e.target.closest('.btn')) addRippleEffect(e);
            });
            document.addEventListener('input', e => {
                if (e.target.classList.contains('input-field') || e.target.classList.contains('select-field')) {
                    const error = e.target.parentElement.querySelector('.error-message');
                    if (error) {
                        const isInvalid = e.target.type === 'number' ? (e.target.value < 0 || !e.target.value) : !e.target.value;
                        e.target.parentElement.classList.toggle('invalid', isInvalid);
                        error.style.display = isInvalid ? 'block' : 'none';
                    }
                }
            });
            window.addEventListener('resize', () => {
                Object.values(charts).filter(chart => chart).forEach(chart => chart.resize());
            });
            // Initialize dashboard with default values
            elements.dashIncome.textContent = 'â‚¹0.00';
            elements.dashExpenses.textContent = 'â‚¹0.00';
            elements.dashSavings.textContent = 'â‚¹0.00';
            elements.dashProgress.textContent = '0%';
        });
    </script>
</body>
</html>